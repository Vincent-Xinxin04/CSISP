# CSISP后端中间件设计文档

## 概述

CSISP后端项目采用Koa.js框架，中间件系统是其核心架构之一。中间件负责处理HTTP请求的生命周期，包括认证、授权、日志记录、错误处理、跨域支持等横切关注点。

## 中间件架构设计

### 核心中间件栈

我们的中间件按照以下顺序执行：

```
1. 错误处理中间件 (errorHandler)
2. CORS中间件 (cors)
3. 日志中间件 (logger)
4. 速率限制中间件 (rateLimit)
5. 认证中间件 (jwtAuth)
6. 参数验证中间件 (validation)
7. 业务路由中间件 (routes)
```

### 中间件类型定义

#### AppContext接口

```typescript
export interface AppContext extends KoaContext {
  request: CustomRequest;
  response: CustomResponse;
  userId?: number;
  user?: User;
  roles?: UserRoleType[];
  state: KoaContext['state'] & {
    user?: User;
    userId?: number;
    roles?: UserRoleType[];
  };
  // 保持Koa原始属性
  params: KoaContext['params'];
  query: KoaContext['query'];
  body: KoaContext['body'];
  status: KoaContext['status'];
  method: KoaContext['method'];
  url: KoaContext['url'];
  path: KoaContext['path'];
  headers: KoaContext['headers'];
  get: KoaContext['get'];
  set: KoaContext['set'];
  ip: KoaContext['ip'];
  is: KoaContext['is'];
  app: KoaContext['app'];
  req: KoaContext['req'];
  res: KoaContext['res'];
  originalUrl: KoaContext['originalUrl'];
  cookies: KoaContext['cookies'];
  throw: KoaContext['throw'];
  assert: KoaContext['assert'];
  respond: KoaContext['respond'];
}
```

#### Middleware类型

```typescript
export type Middleware = (ctx: AppContext, next: Next) => Promise<void>;
export type Next = () => Promise<void>;
```

## 中间件详细设计

### 1. 认证中间件 (auth.ts)

#### JWT认证中间件

**功能**：验证JWT令牌并提取用户信息

**配置选项**：

```typescript
interface AuthMiddlewareOptions {
  required?: boolean; // 是否需要认证
  roles?: UserRoleType[]; // 允许的角色列表
  permissions?: string[]; // 允许的权限列表
  excludePaths?: string[]; // 排除的路径
}
```

**使用示例**：

```typescript
// 基础认证
router.get('/profile', jwtAuth(), getProfile);

// 需要管理员角色
router.post('/users', jwtAuth({ roles: ['admin'] }), createUser);

// 可选认证
router.get('/public', jwtAuth({ required: false }), getPublicData);

// 排除特定路径
router.use(jwtAuth({ excludePaths: ['/login', '/register'] }));
```

#### 角色权限中间件

**requireRole**：检查用户是否具有指定角色
**requireAdmin**：检查管理员权限
**requireTeacher**：检查教师权限
**requireStudent**：检查学生权限
**requireSelfOrAdmin**：允许用户访问自己的资源或管理员访问

### 2. 错误处理中间件 (error.ts)

#### 统一错误处理

**功能**：捕获所有未处理的错误并格式化响应

**配置选项**：

```typescript
interface ErrorMiddlewareOptions {
  showDetailsInDev?: boolean; // 开发环境显示详细信息
  logErrors?: boolean; // 是否记录错误日志
  errorMappings?: Record<
    string,
    {
      // 自定义错误映射
      code: number;
      message: string;
    }
  >;
}
```

**错误类型处理**：

- ValidationError：参数验证失败 (400)
- UnauthorizedError：未授权访问 (401)
- ForbiddenError：权限不足 (403)
- NotFoundError：资源不存在 (404)
- ConflictError：资源冲突 (409)
- SequelizeUniqueConstraintError：数据已存在 (409)
- SequelizeValidationError：数据验证失败 (400)

#### 404错误处理

处理未找到的路由，返回标准化的404响应

### 3. 日志中间件 (logger.ts)

#### 请求日志记录

**功能**：记录请求和响应信息

**配置选项**：

```typescript
interface LoggerMiddlewareOptions {
  logBody?: boolean; // 是否记录请求体
  logResponse?: boolean; // 是否记录响应体
  excludePaths?: string[]; // 排除的路径
  sensitiveFields?: string[]; // 要屏蔽的敏感字段
}
```

**日志格式**：

```json
{
  "method": "POST",
  "url": "/api/users/login",
  "status": 200,
  "duration": "45ms",
  "ip": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "userId": 123
}
```

#### 敏感数据脱敏

自动屏蔽敏感字段如：password, token, authorization

### 4. 速率限制中间件 (rateLimit.ts)

#### 内存存储速率限制

**功能**：防止API被过度使用

**配置选项**：

```typescript
interface RateLimitMiddlewareOptions {
  windowMs?: number; // 时间窗口（毫秒）
  max?: number; // 最大请求数
  keyGenerator?: (ctx: AppContext) => string; // 键生成器
  message?: string; // 自定义消息
  excludePaths?: string[]; // 排除的路径
}
```

**预设策略**：

- **strictRateLimit**：严格限制（5分钟窗口，10次请求）
- **relaxedRateLimit**：宽松限制（1分钟窗口，1000次请求）
- **userRateLimit**：基于用户的限制
- **apiRateLimit**：基于API端点的限制

**响应头**：

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 2024-01-01T00:00:00.000Z
```

### 5. CORS中间件 (cors.ts)

#### 跨域资源共享

**功能**：处理跨域请求

**配置选项**：

```typescript
interface CorsMiddlewareOptions {
  origin?: string | string[] | ((ctx: AppContext) => string);
  credentials?: boolean;
  allowMethods?: string | string[];
  allowHeaders?: string | string[];
  exposeHeaders?: string | string[];
  maxAge?: number;
}
```

**默认配置**：

```typescript
export const defaultCors: Middleware = cors({
  origin: (ctx: AppContext) => {
    const origin = ctx.get('Origin');
    const allowedOrigins = [
      'http://localhost:3000',
      'http://localhost:3001',
      'http://localhost:5173',
      'http://localhost:5174',
    ];

    if (process.env.NODE_ENV === 'development') {
      return origin || '*';
    }

    return allowedOrigins.includes(origin) ? origin : allowedOrigins[0];
  },
  credentials: true,
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowHeaders: [
    'Content-Type',
    'Authorization',
    'X-Requested-With',
    'X-CSRF-Token',
    'Accept',
    'Accept-Language',
    'Content-Language',
  ],
  exposeHeaders: ['X-Total-Count', 'X-Page', 'X-Page-Size'],
  maxAge: 86400,
});
```

### 6. 参数验证中间件 (validation.ts)

#### 必填参数验证

**validateRequired**：验证必填字段

```typescript
router.post('/register', validateRequired(['username', 'password', 'email']), registerUser);
```

#### 分页参数验证

**validatePagination**：验证分页参数，设置默认值

```typescript
router.get('/users', validatePagination(), getUsers);
```

#### ID参数验证

**validateIdParam**：验证URL中的ID参数

```typescript
router.get('/users/:id', validateIdParam('id'), getUserById);
```

### 7. 文件上传中间件 (upload.ts)

#### 文件上传处理

**功能**：处理文件上传和验证

**配置选项**：

```typescript
interface UploadMiddlewareOptions {
  maxFileSize?: number; // 最大文件大小
  allowedTypes?: string[]; // 允许的文件类型
  uploadDir?: string; // 上传目录
  preserveFilename?: boolean; // 保留原始文件名
  maxFiles?: number; // 最大文件数量
}
```

**专用中间件**：

- **imageUpload**：图片上传（支持jpeg, png, gif, webp）
- **documentUpload**：文档上传（支持pdf, doc, docx, txt）
- **singleFileUpload**：单文件上传
- **multipleFileUpload**：多文件上传

## 中间件组合使用

### 典型路由配置

```typescript
// 公开路由 - 无需认证
router.get('/health', getHealth);
router.post('/auth/login', validateRequired(['username', 'password']), login);

// 需要认证的路由
router.get('/profile', jwtAuth(), getProfile);

// 需要特定角色的路由
router.post(
  '/courses',
  jwtAuth({ roles: ['teacher'] }),
  validateRequired(['name', 'code']),
  createCourse
);

// 需要分页的路由
router.get('/users', jwtAuth({ roles: ['admin'] }), validatePagination(), getUsers);

// 文件上传路由
router.post(
  '/upload/avatar',
  jwtAuth(),
  imageUpload({ maxFileSize: 5 * 1024 * 1024 }),
  uploadAvatar
);
```

### 全局中间件配置

```typescript
app.use(errorHandler());
app.use(defaultCors);
app.use(logger({ logBody: true }));
app.use(rateLimit({ max: 100 }));
app.use(bodyParser());
```

## 性能优化

### 1. 中间件执行顺序

- 错误处理中间件应该在最前面
- 静态资源中间件应该尽早返回
- 认证中间件应该放在需要认证的路由之前

### 2. 条件执行

```typescript
// 只在开发环境启用详细日志
if (process.env.NODE_ENV === 'development') {
  app.use(logger({ logBody: true, logResponse: true }));
}

// 只在生产环境启用速率限制
if (process.env.NODE_ENV === 'production') {
  app.use(rateLimit({ max: 50 }));
}
```

### 3. 缓存策略

```typescript
// 对静态资源使用缓存
app.use(staticCache({ maxAge: 86400 }));

// 对API响应使用条件缓存
app.use(conditionalGet());
app.use(etag());
```

## 安全考虑

### 1. 认证安全

- JWT令牌使用强密钥签名
- 设置合理的令牌过期时间
- 支持令牌刷新机制
- 敏感操作需要重新认证

### 2. 输入验证

- 所有用户输入都需要验证
- 使用参数化查询防止SQL注入
- 对文件上传进行类型和大小检查
- 敏感数据自动脱敏

### 3. 速率限制

- 根据用户类型设置不同的限制
- 对敏感操作使用更严格的限制
- 实现IP黑名单机制
- 监控异常请求模式

## 监控和调试

### 1. 日志监控

- 记录所有错误和异常
- 监控API响应时间
- 跟踪用户行为模式
- 设置告警阈值

### 2. 性能监控

- 监控中间件执行时间
- 跟踪数据库查询性能
- 监控内存使用情况
- 分析请求模式

### 3. 错误追踪

- 集成错误追踪服务
- 记录完整的错误堆栈
- 关联用户会话信息
- 实现错误聚合和分析

## 测试策略

### 1. 单元测试

```typescript
describe('JWT Auth Middleware', () => {
  it('should reject requests without token', async () => {
    const ctx = createMockContext();
    const next = jest.fn();

    await jwtAuth()(ctx, next);

    expect(ctx.status).toBe(401);
    expect(ctx.body.code).toBe(401);
  });
});
```

### 2. 集成测试

```typescript
describe('API Integration', () => {
  it('should handle complete request flow', async () => {
    const response = await request(app)
      .post('/api/users')
      .set('Authorization', 'Bearer valid-token')
      .send({ username: 'test', password: '123456' });

    expect(response.status).toBe(201);
    expect(response.body.code).toBe(201);
  });
});
```

## 最佳实践

### 1. 中间件设计原则

- **单一职责**：每个中间件只负责一个功能
- **可配置**：提供灵活的配置选项
- **可测试**：易于单元测试
- **可重用**：不依赖特定业务逻辑

### 2. 错误处理

- 统一错误格式
- 提供有用的错误信息
- 记录详细的错误日志
- 区分开发和生产环境

### 3. 性能优化

- 避免不必要的中间件执行
- 使用条件中间件
- 实现中间件缓存
- 监控性能指标

### 4. 安全实践

- 验证所有输入
- 使用安全的默认值
- 实现适当的访问控制
- 定期更新依赖

## 总结

CSISP后端中间件系统提供了完整的企业级功能，包括认证、授权、日志、错误处理、性能优化等。通过合理的架构设计和最佳实践，确保了系统的安全性、可维护性和可扩展性。

中间件系统的设计遵循了以下原则：

- **模块化**：每个中间件独立负责特定功能
- **可配置**：提供灵活的配置选项
- **类型安全**：完整的TypeScript类型支持
- **高性能**：优化的执行流程和缓存策略
- **安全**：多层次的安全保护措施

这套中间件系统为CSISP项目提供了坚实的基础，支持复杂的业务需求和高并发场景。
