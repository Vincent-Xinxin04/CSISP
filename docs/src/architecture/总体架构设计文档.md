# 计算机学院综合服务平台(CSISP)系统架构设计文档

## 1. 文档概述

### 1.1 文档目的

本文档基于CSISP业务需求，从技术架构角度详细描述系统的总体设计、核心模块、技术选型、数据流向及交互关系，为系统开发、测试和维护提供技术指导。

### 1.2 业务背景

CSISP是计算机学院专注于学生考勤管理和作业管理的综合服务系统，支持管理员、学生、课代表和学生干部等多角色访问，实现课程管理、考勤打卡、作业发布与提交等核心功能。

### 1.3 设计原则

- **分层架构**：清晰分离用户层、前端层、后端层、数据层
- **模块化**：高内聚低耦合的模块划分
- **安全性**：严格的权限控制
- **可维护性**：代码结构清晰，文档齐全

---

## 2. 系统总体架构

### 2.1 架构分层

系统采用「前端应用 + BFF + backend-integrated + 数据层」的分层架构设计，各层职责明确，便于维护和扩展：

```mermaid
graph TB
    %% 用户层
    subgraph 用户层
        A[管理员终端]
        B[学生终端]
        C[课代表终端]
        D[学生干部终端]
    end

    %% 前端层
    subgraph 前端层
        F[frontend-admin 后台管理]
        G[frontend-portal 门户应用]
    end

    %% BFF 层
    subgraph BFF 层
        H[bff
Koa 应用]
    end

    %% 后端服务层
    subgraph 后端服务层
        I[backend-integrated
NestJS 后端]
        J[用户管理模块]
        K[课程管理模块]
        L[考勤管理模块]
        M[作业管理模块]
        N[通知管理模块]
        O[仪表盘模块]
    end

    %% 中间件层
    subgraph 中间件层
        R[Redis 缓存]
        S[JWT 认证]
    end

    %% 数据层
    subgraph 数据层
        Q[PostgreSQL 数据库]
    end

    %% 数据流
    A --> F
    B --> G
    C --> G
    D --> G
    F --> H
    G --> H
    H --> I
    I --> J
    I --> K
    I --> L
    I --> M
    I --> N
    I --> O
    J --> R
    K --> R
    L --> R
    M --> R
    N --> R
    J --> Q
    K --> Q
    L --> Q
    M --> Q
    N --> Q
    O --> Q
    I --> S
```

### 2.2 各层职责

| 层级       | 主要职责                     | 核心组件                                       |
| ---------- | ---------------------------- | ---------------------------------------------- |
| 用户层     | 系统的直接用户接口           | 管理员/学生/课代表/学生干部终端                |
| 前端层     | 提供用户交互界面             | `apps/frontend-admin`、`apps/frontend-portal`  |
| BFF 层     | 聚合后端接口，适配前端场景   | `apps/bff`（Koa + TypeScript）                 |
| 后端服务层 | 领域业务逻辑与 REST API 提供 | `apps/backend-integrated`（NestJS 模块化后端） |
| 中间件层   | 缓存、认证、授权与日志       | Redis（`@csisp/redis`）、JWT、`@csisp/logger`  |
| 数据层     | 结构化数据存储与检索         | PostgreSQL 15                                  |

---

## 3. 技术栈选型

### 3.1 backend-integrated 技术栈

| 技术/框架                   | 用途          | 选型理由                                  |
| --------------------------- | ------------- | ----------------------------------------- |
| NestJS                      | 后端服务框架  | 模块化、DI 体系完善，适合中大型业务系统   |
| TypeScript                  | 类型安全语言  | 增强可维护性、统一前后端类型              |
| PostgreSQL                  | 关系型数据库  | 稳定可靠，支持事务和复杂查询              |
| Redis                       | 缓存/会话存储 | 提高热点数据访问速度，降低数据库压力      |
| Sequelize                   | ORM 框架      | 与现有模型/迁移体系兼容，支持 TypeScript  |
| JWT                         | 令牌认证      | 轻量级身份验证，便于前后端分离            |
| @csisp/redis + @infra/redis | 缓存访问封装  | 统一 Redis 客户端的使用方式和命名空间管理 |

### 3.2 BFF 技术栈

| 技术/框架       | 用途         | 选型理由                              |
| --------------- | ------------ | ------------------------------------- |
| Koa 3.x         | Web 框架     | 轻量、组合中间件灵活，适合作为 BFF 层 |
| @koa/router     | 路由管理     | Koa 官方路由生态，简单易用            |
| TypeScript      | 类型安全语言 | 对齐整体技术栈，增强可维护性          |
| undici          | HTTP 客户端  | 现代 Node 原生 HTTP 客户端实现        |
| @csisp/upstream | 上游封装     | 统一后端调用、错误处理与链路追踪      |
| dotenv          | 配置管理     | 按环境加载 .env 配置                  |

### 3.3 前端中台技术栈

| 技术/框架  | 版本 | 用途         | 选型理由                              |
| ---------- | ---- | ------------ | ------------------------------------- |
| Vue 3      | 3.4  | 前端框架     | 响应式、组合式API、性能优异           |
| TypeScript | 5.2  | 类型安全语言 | 增强代码可维护性，减少运行时错误      |
| Vite       | 5.0  | 构建工具     | 快速构建，支持热更新                  |
| Naive-UI   | 2.38 | UI组件库     | 现代化设计，完整的组件支持            |
| Axios      | 1.6  | HTTP客户端   | 简单易用，支持拦截器和请求配置        |
| Vue Router | 4.3  | 路由管理     | Vue生态官方路由，支持TypeScript       |
| Pinia      | 2.1  | 状态管理     | Vue生态新一代状态管理，支持TypeScript |
| Sass       | 1.77 | 样式预处理器 | 增强CSS的可维护性和扩展性             |
| ECharts    | 5.5  | 图表库       | 强大的数据可视化能力                  |

### 3.4 文档技术栈

| 技术/框架 | 版本 | 用途     | 选型理由                        |
| --------- | ---- | -------- | ------------------------------- |
| VitePress | 1.1  | 文档框架 | Vite生态的文档框架，支持Vue组件 |

### 3.5 基础设施与质量保障

| 工具/配置               | 用途         | 说明                                                              |
| ----------------------- | ------------ | ----------------------------------------------------------------- |
| Docker + docker-compose | 本地基础设施 | 通过 `infra/database/docker-compose.db.yml` 启动 PostgreSQL/Redis |
| GitHub Actions          | CI/CD        | `.github/workflows/deploy-docs.yml`、`sync-env-variables.yml`     |
| ESLint                  | 代码检查     | 根 `eslint.config.ts`                                             |
| Prettier                | 代码格式化   | 根 `.prettierrc`                                                  |
| Stylelint               | 样式检查     | `stylelint.config.js`                                             |
| EditorConfig            | 编辑器配置   | 根 `.editorconfig`                                                |

---

## 4. 核心模块设计

### 4.1 用户管理模块

#### 4.1.1 功能职责

- 用户身份认证与授权
- 角色管理与权限分配
- 用户信息维护
- 课代表角色分配

#### 4.1.2 技术设计

```mermaid
graph TD
    A[用户登录请求] --> B[前端发送请求到后端]
    B --> C[Nginx转发到用户管理服务]
    C --> D[JWT令牌生成]
    D --> E[令牌返回前端]
    F[权限验证请求] --> G[前端携带令牌请求]
    G --> H[后端解析令牌]
    H --> I[RBAC权限校验]
    I --> J[校验通过返回数据]
    J --> K[前端渲染页面]
```

#### 4.1.3 关键表结构

```mermaid
erDiagram
    USER ||--o{ USER_ROLE : 拥有
    ROLE ||--o{ ROLE_PERMISSION : 拥有
    PERMISSION ||--o{ MENU : 对应
    USER ||--o{ COURSE_REP : 担任
    COURSE_REP ||--o{ COURSE : 管理
```

### 4.2 课程管理模块

#### 4.2.1 功能职责

- 课程信息维护
- 教师与课程关联
- 课程时间槽管理
- 课程班级划分

#### 4.2.2 技术设计

```mermaid
flowchart TD
    A[管理员创建课程] --> B[课程信息保存到PostgreSQL]
    B --> C[课程信息缓存到Redis]
    D[学生查询课程] --> E[从Redis获取课程列表]
    E --> F[Redis不存在从PostgreSQL查询]
    F --> G[结果缓存到Redis]
    G --> H[返回学生端]
```

#### 4.2.3 数据结构

```mermaid
erDiagram
    COURSE {
        int id PK
        string course_name
        string course_code
        datetime create_time
        int status
    }
    TEACHER {
        int id PK
        string real_name
        string email
        string phone
    }
    COURSE_TEACHER {
        int course_id FK
        int teacher_id FK
    }
    TIME_SLOT {
        int id PK
        int course_id FK
        int week_day
        time start_time
        time end_time
    }
    "CLASS" {
        int id PK
        int course_id FK
        string class_name
    }

    COURSE ||--o{ COURSE_TEACHER : 关联
    TEACHER ||--o{ COURSE_TEACHER : 关联
    COURSE ||--o{ TIME_SLOT : 拥有
    COURSE ||--o{ "CLASS" : 划分
```

### 4.3 考勤管理模块

#### 4.3.1 功能职责

- 考勤任务发布
- 学生打卡
- 考勤记录统计
- 考勤异常处理

#### 4.3.2 技术设计

```mermaid
flowchart TD
    A[教师发布考勤] --> B[生成考勤任务]
    B --> C[保存任务到 PostgreSQL]
    C --> D[可选：写入 Redis 缓存（活跃任务列表）]
    E[学生打卡请求] --> F[backend-integrated 验证时间范围]
    F -->|有效| G[记录考勤到 PostgreSQL]
    G --> H[失效相关统计缓存]
    I[课代表/学生查询统计] --> J[先查 Redis 缓存]
    J -->|命中| K[返回统计结果]
    J -->|未命中| L[从 PostgreSQL 聚合统计]
    L --> M[写入 Redis 缓存]
    M --> K
```

#### 4.3.3 数据结构

```mermaid
erDiagram
    ATTENDANCE_TASK {
        int id PK
        int course_id FK
        datetime start_time
        datetime end_time
        string status
    }
    ATTENDANCE_RECORD {
        int id PK
        int task_id FK
        int student_id FK
        datetime checkin_time
        string status
    }
    ATTENDANCE_DETAIL {
        string id PK
        int record_id FK
        string ip_address
        string device_info
    }

    ATTENDANCE_TASK ||--o{ ATTENDANCE_RECORD : 包含
    ATTENDANCE_RECORD ||--o{ ATTENDANCE_DETAIL : 详情
```

### 4.4 作业管理模块

#### 4.4.1 功能职责

- 作业发布
- 作业提交
- 作业批改与评分
- 提交情况统计

#### 4.4.2 技术设计

```mermaid
flowchart TD
    A[教师/课代表发布作业] --> B[作业信息保存到 PostgreSQL]
    B --> C[可选：写入 Redis 缓存（班级作业列表）]
    D[学生查看作业] --> E[通过 BFF 调用 backend-integrated]
    E --> F[读取 Redis；未命中则查询 PostgreSQL]
    G[学生提交作业] --> H[验证截止时间 + 作业状态]
    H -->|有效| I[保存提交记录到 PostgreSQL]
    I --> J[可选：记录附件信息]
    I --> K[失效相关统计与列表缓存]
    L[教师查看提交情况] --> M[分页查询提交记录 + 附件]
    N[批改作业] --> O[更新评分到 PostgreSQL]
    O --> P[失效统计缓存]
```

#### 4.4.3 数据结构

```mermaid
erDiagram
    HOMEWORK {
        int id PK
        int course_id FK
        string title
        text content
        datetime deadline
    }
    HOMEWORK_SUBMISSION {
        int id PK
        int homework_id FK
        int student_id FK
        string file_path
        datetime submit_time
        string status
    }
    HOMEWORK_GRADE {
        int id PK
        int submission_id FK
        int score
        text comment
        datetime grade_time
    }

    HOMEWORK ||--o{ HOMEWORK_SUBMISSION : 提交
    HOMEWORK_SUBMISSION ||--o{ HOMEWORK_GRADE : 评分
    HOMEWORK_SUBMISSION ||--o{ HOMEWORK_FILE : 文件
```

### 4.5 通知管理模块

#### 4.5.1 功能职责

- 通知发布
- 实时通知推送
- 阅读状态管理
- 通知历史查询

#### 4.5.2 技术设计

```mermaid
flowchart TD
    A[学生干部/管理员发布通知] --> B[内容校验]
    B -->|通过| C[通知保存到 PostgreSQL]
    C --> D[可选：记录到 Redis 以加速列表查询]
    E[学生查看通知列表] --> F[通过 BFF 调用 backend-integrated]
    F --> G[从 Redis 或 PostgreSQL 读取通知列表]
    H[学生标记已读] --> I[更新阅读状态到 PostgreSQL]
    I --> J[可选：更新缓存]
```

#### 4.5.3 推送机制

- WebSocket实时推送在线用户
- 仅推送给订阅相关课程的用户
- 支持作业发布和考勤任务通知

---

## 5. API设计规范

### 5.1 API设计原则

- RESTful风格
- 统一错误码和错误信息
- 输入参数验证
- 使用`/api`作为前缀

### 5.2 API示例

```bash
# 用户登录
POST /api/auth/login
{"username":"string","password":"string"}

# 查询课程列表
GET /api/courses?page=1&size=10

# 学生打卡
POST /api/attendance/checkin
{"courseId":"string"}

# 发布作业
POST /api/homework/publish
{"courseId":"string","title":"string","content":"string","deadline":"string"}
```

### 5.3 身份认证与授权

- 使用JWT令牌进行身份验证
- 令牌有效期：1小时
- 密码加密存储(BCrypt)
- 请求头携带`Authorization: Bearer <token>`

---

## 6. 数据存储设计

### 6.1 数据库设计

#### 6.1.1 核心数据库表

```mermaid
erDiagram
    USER {
        int id PK
        string username
        string password
        string real_name
        string email
        string phone
        int status
    }
    COURSE {
        int id PK
        string course_name
        string course_code
        datetime create_time
        int status
    }
    ATTENDANCE {
        int id PK
        int course_id FK
        int user_id FK
        datetime checkin_time
        string status
    }
    HOMEWORK {
        int id PK
        int course_id FK
        string title
        text content
        datetime deadline
    }
    NOTIFICATION {
        int id PK
        int sender_id FK
        string title
        text content
        datetime create_time
        int read_count
    }
```

#### 6.1.2 缓存设计

- 缓存层：Redis（通过 `@csisp/redis`，在 backend-integrated 中经 `@infra/redis` 使用）
- 缓存对象：
  - 课程列表/详情
  - 考勤统计（学生/班级）与活跃任务
  - 作业列表/统计/提交情况
  - 仪表盘统计数据
- 缓存策略：Cache-Aside，写操作后删除相关 key；TTL 按数据类型控制（详情/分布 300s，列表 120s，统计 30–60s）。

### 6.2 非结构化数据存储

> 当前系统核心数据全部存储于 PostgreSQL，后续若接入对象存储或搜索引擎，将在数据库文档中补充说明。

- 作业附件：暂由后端保存元数据到数据库，文件存储策略视部署环境而定（本地磁盘或外部存储）。

---

## 7. 安全架构设计

### 7.1 身份认证

- JWT令牌认证
- 密码加密存储(BCrypt)

### 7.2 授权机制

- RBAC基于角色的访问控制
- 菜单和API权限控制

### 7.3 安全防护

- 输入参数校验
- SQL注入防护(MyBatis-Plus参数化查询)

---

## 8. 业务线流程设计

### 8.1 整体业务流程架构

```mermaid
graph TB
    %% 用户层
    subgraph 用户层
        A[管理员]
        B[学生]
        C[课代表]
        D[学生干部]
    end

    %% 前端层
    subgraph 前台应用
        E[学生首页]
        F[课程列表]
        G[考勤页面]
        H[作业页面]
        I[通知中心]
    end

    subgraph 后台管理
        J[用户管理]
        K[课程管理]
        L[系统设置]
    end

    %% 后端服务
    subgraph 后端服务
        M[认证服务]
        N[课程服务]
        O[考勤服务]
        P[作业服务]
        Q[通知服务]
        R[权限服务]
    end

    %% 数据层
    subgraph 数据层
        S[PostgreSQL]
        T[Redis]
    end

    %% 用户登录与权限验证
    A -->|登录| M
    B -->|登录| M
    C -->|登录| M
    D -->|登录| M
    M -->|验证权限| R
    R -->|返回权限| M

    %% 管理员业务线
    A -->|进入| J
    A -->|进入| K
    A -->|进入| L
    J -->|用户管理| N
    K -->|课程管理| O
    L -->|系统设置| P

    %% 学生业务线
    B -->|进入| E
    B -->|查看课程| F
    B -->|考勤打卡| G
    B -->|提交作业| H
    B -->|查看通知| I
    G -->|调用| O
    H -->|调用| P
    I -->|调用| Q

    %% 课代表业务线
    C -->|进入| E
    C -->|查看课程| F
    C -->|管理考勤| G
    C -->|发布作业| H
    C -->|查看通知| I
    G -->|调用| O
    H -->|调用| P
    I -->|调用| Q

    %% 学生干部业务线
    D -->|进入| E
    D -->|查看课程| F
    D -->|查看考勤| G
    D -->|查看作业| H
    D -->|发布通知| I
    I -->|调用| Q

    %% 服务与数据交互
    N -->|数据| S
    O -->|数据| S
    P -->|数据| S
    Q -->|数据| S
    R -->|缓存| T
    M -->|缓存| T
    G -->|缓存| T
```

### 8.2 不同身份业务流程

#### 8.2.1 管理员业务流程

```mermaid
graph TD
    A[管理员登录] --> B[权限验证]
    B -->|验证通过| C[进入后台管理页]
    C -->|选择操作| D{
        用户管理
        课程管理
        系统设置
    }
    D -->|用户管理| E[管理学生信息]
    D -->|课程管理| F[管理课程信息]
    D -->|系统设置| G[系统参数配置]
    E -->|保存| H[数据库更新]
    F -->|保存| H
    G -->|保存| H
```

#### 8.2.2 学生业务流程

```mermaid
graph TD
    A[学生登录] --> B[权限验证]
    B -->|验证通过| C[进入学生首页]
    C -->|选择操作| D{
        课程列表
        考勤打卡
        作业提交
        通知中心
    }
    D -->|课程列表| E[查看已选课程]
    D -->|考勤打卡| F[进行考勤操作]
    D -->|作业提交| G[提交课程作业]
    D -->|通知中心| H[查看系统通知]
    F -->|验证时间| I{有效时间?}
    I -->|是| J[记录考勤]
    I -->|否| K[提示无效]
    G -->|验证截止时间| L{未截止?}
    L -->|是| M[保存作业]
    L -->|否| N[提示已截止]
```

#### 8.2.3 课代表业务流程

```mermaid
graph TD
    A[课代表登录] --> B[权限验证]
    B -->|验证通过| C[进入学生首页]
    C -->|选择操作| D{
        课程列表
        考勤管理
        作业管理
        通知中心
    }
    D -->|课程列表| E[查看已选课程]
    D -->|考勤管理| F[管理课程考勤]
    D -->|作业管理| G[发布课程作业]
    D -->|通知中心| H[查看系统通知]
    F -->|设置考勤| I[生成考勤任务]
    G -->|发布作业| J[保存作业信息]
    I -->|发送通知| K[推送考勤通知]
    J -->|发送通知| L[推送作业通知]
```

#### 8.2.4 学生干部业务流程

```mermaid
graph TD
    A[学生干部登录] --> B[权限验证]
    B -->|验证通过| C[进入学生首页]
    C -->|选择操作| D{
        课程列表
        考勤查看
        作业查看
        通知管理
    }
    D -->|课程列表| E[查看已选课程]
    D -->|考勤查看| F[查看课程考勤]
    D -->|作业查看| G[查看课程作业]
    D -->|通知管理| H[发布系统通知]
    H -->|验证内容| I{内容合规?}
    I -->|是| J[保存通知]
    I -->|否| K[提示修改]
    J -->|推送通知| L[发送给学生]
```

## 9. 总结

本文档基于CSISP业务需求，设计了一套完整的系统架构方案，涵盖了从前端到后端、从数据存储到安全防护的各个方面。该架构严格按照指定技术栈构建，采用了分层设计、模块化开发和微服务思想，确保了系统的高可用性、高扩展性和安全性，能够满足计算机学院的业务需求。

重点展示了不同身份用户登录后的业务流程，清晰地呈现了系统的业务线架构和用户操作流程。
